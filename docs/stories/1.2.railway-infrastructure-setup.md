# Story 1.2: Railway Infrastructure Setup

## Status
InProgress

## Story
**As a** Developer/Maintainer,
**I want** to configure Railway infrastructure,
**so that** I have a deployable environment for the application

## Acceptance Criteria
1. Railway project linked to the repository and CLI
2. Development, Staging, and Production environments created
3. Railway services created for each environment (frontend/back and dev/staging variants)
4. Environment variables configured per service (API URLs, OAuth secrets, ports)
5. Custom domains mapped (`dev.ondatra-ai.xyz`, `api.dev.ondatra-ai.xyz`, etc.) with DNS verified
6. Deployments validated for each environment via Railway CLI/GitHub Actions

## Tasks / Subtasks

- [ ] Task 1: Railway Project & Authentication (AC: 1)
  - [x] Create Railway project and retrieve project ID `801ad5e0-95bf-4ce6-977e-6f2fa37529fd`
  - [x] Add `RAILWAY_GITHUB_ACTIONS` token to GitHub secrets
  - [ ] Document `railway login`/`railway link` steps for local developers

- [ ] Task 2: Environment Provisioning (AC: 2)
  - [x] Create `production`, `development`, and `staging` environments
  - [x] Document branch-to-environment mapping
  - [ ] Validate CLI environment switching (`railway environment <name>`)

- [ ] Task 3: Service Creation (AC: 3)
  - [x] Provision services `frontend`, `backend`, `frontend-dev`, `backend-dev`, `frontend-staging`, `backend-staging`
  - [ ] Record service IDs for reference
  - [ ] Ensure services use Docker deploy (Dockerfiles in repo)

- [ ] Task 4: Environment Variables & Secrets (AC: 4)
  - [x] Set `NEXT_PUBLIC_API_URL` / `NEXT_PUBLIC_BACKEND_URL` for frontend services
  - [x] Set `PORT=8080` for backend services
  - [ ] Document OAuth secrets/credentials management within Railway
  - [ ] Provide script/snippet for syncing env vars across environments

- [ ] Task 5: Custom Domains & DNS (AC: 5)
  - [x] Generate Railway domains for dev/staging/production services
  - [x] Configure CNAMEs (`dev.ondatra-ai.xyz`, `api.dev.ondatra-ai.xyz`, etc.)
  - [ ] Verify propagation for all custom domains (dev, staging, prod)
  - [ ] Update documentation with DNS targets and validation steps

- [ ] Task 6: Deployment Validation (AC: 6)
  - [x] Execute `railway up` for each service from CI
  - [ ] Confirm GitHub workflow `deploy_to_railway.yml` deploys to the correct environment
  - [ ] Document manual deployment steps (`railway up --service ... --path-as-root ...`)
  - [ ] Smoke test each environment via its custom domain and default Railway domain

## Dev Notes

### Previous Story Insights
From Story 1.1 we have:
- Dockerized frontend (`services/frontend`) and backend (`services/backend`)
- Health check endpoints for backend (`/health`) and frontend (root route)
- Playwright/Jest testing harnesses

### Environment & Service Matrix
| Environment | Frontend Service | Backend Service | Custom Domains |
|-------------|-----------------|-----------------|----------------|
| Development | `frontend-dev`  | `backend-dev`   | `dev.ondatra-ai.xyz`, `api.dev.ondatra-ai.xyz` |
| Staging     | `frontend-staging` | `backend-staging` | `staging.ondatra-ai.xyz` (planned), `api.staging.ondatra-ai.xyz` |
| Production  | `frontend`      | `backend`       | `app.ondatra-ai.xyz` (planned), `api.ondatra-ai.xyz` |

### File Locations
- Railway configuration: `railway.toml`, `service.toml`
- GitHub workflow: `.github/workflows/deploy_to_railway.yml`
- Custom domain documentation: `docs/architecture.md` (Infrastructure section)

### Testing Requirements
- `railway up --service <name> --path-as-root <dir>` succeeds for all services
- GitHub workflow manually dispatched for each environment and passes
- `curl` health check to every environment-specific domain returns 200/healthy payload

### Open Questions / Future Enhancements
- Add automated smoke tests post-deploy (Playwright hitting Railway domains)
- Consider Railway add-ons (Redis, Postgres) if persistence is needed later
- Evaluate secret management tooling for syncing OAuth credentials across environments
