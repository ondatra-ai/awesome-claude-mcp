# Story 3.1: MCP Server Implementation

## Status
Draft

## Story
**As a** Developer/Maintainer
**I want** to implement MCP protocol server
**So that** Claude can communicate with the service

## Acceptance Criteria
1. WebSocket server implemented
2. HTTP endpoint for MCP available
3. Message parsing and validation
4. Response formatting to MCP standard
5. Connection management handled
6. Concurrent connection support

## Tasks / Subtasks
- [ ] Set up WebSocket server infrastructure (AC: 1, 5, 6)
  - [ ] Configure WebSocket endpoint `/mcp` with protocol upgrade
  - [ ] Implement connection lifecycle management (connect, disconnect, error handling)
  - [ ] Add concurrent connection support with goroutines
  - [ ] Implement connection state tracking
- [ ] Implement HTTP endpoint for MCP protocol (AC: 2)
  - [ ] Create HTTP handler that upgrades to WebSocket protocol
  - [ ] Add proper CORS handling for Claude client connections
  - [ ] Configure endpoint routing in main server
- [ ] Build MCP message processing system (AC: 3, 4)
  - [ ] Implement message parsing for incoming MCP requests
  - [ ] Add message validation against MCP protocol standards
  - [ ] Create response formatting to MCP standard format
  - [ ] Handle message correlation IDs for request/response tracking
- [ ] Integrate with existing backend infrastructure (AC: 1, 2, 5, 6)
  - [ ] Connect to OAuth Manager for token validation
  - [ ] Integrate with Cache Manager for session management
  - [ ] Add structured logging for all MCP operations
  - [ ] Configure environment variables for MCP server settings

## Dev Notes

### Previous Story Insights
No previous stories exist - this is the first story in the project.

### Technology Stack & Framework Context
[Source: architecture/tech-stack.md#Backend Stack]
- **Language**: Go 1.21 for backend services
- **Framework**: Fiber 2.x for HTTP routing (`cmd/main.go`)
- **MCP Integration**: Mark3Labs MCP-Go library (latest) for Model Context Protocol tools
- **Logging**: zerolog 1.x for structured JSON logs (output to stdout for Railway)
- **Config**: viper 1.x for environment/config management (reads Railway env vars)

### Architecture & Component Integration
[Source: architecture.md#Backend Components]
The MCP Protocol Handler is a key backend component with these responsibilities:
- Handle MCP protocol communication with Claude AI
- WebSocket endpoint for bidirectional communication
- Tool registration and discovery
- Request/response message handling
- Dependencies: Network layer, Command Processor
- Technology Stack: Go stdlib net/http, gorilla/websocket for WebSocket support

### File Structure & Organization
[Source: architecture/coding-standards.md#File Organization]
Following Single Entity Single File Principle:
```
backend/
├── cmd/
│   ├── api/main.go        # REST API server
│   └── mcp/main.go        # MCP WebSocket server (NEW - this story)
├── internal/
│   ├── infrastructure/
│   │   └── server/
│   │       ├── http_server.go         # HTTP server setup
│   │       └── mcp_server.go          # MCP WebSocket server setup (NEW)
│   ├── adapters/
│   │   └── http/
│   │       └── mcp_handler.go         # MCP protocol handlers (NEW)
```

### MCP Integration Requirements
[Source: architecture.md#Tech Stack]
- **MCP Protocol Library**: Mark3Labs MCP-Go (latest) for streamlined Model Context Protocol implementation
- **Features**: Type-safe, stdio transport, LLM-optimized design
- **Integration Point**: Embedded in backend service

### Configuration Management
[Source: architecture/coding-standards.md#Environment Variables]
Required environment variables for MCP server:
```env
MCP_PORT=8081                    # MCP WebSocket server port
ENVIRONMENT=development          # Current environment
LOG_LEVEL=info                   # Logging level
LOG_FORMAT=json                  # Structured logging format
```

### Connection Management Requirements
[Source: architecture.md#Core Workflows]
From the MCP protocol workflow diagram:
- Handle tool calls from Claude AI
- Parse and validate incoming commands
- Integrate with OAuth Manager for token validation
- Connect to Redis Cache for session management
- Process requests and return formatted responses

### Error Handling Standards
[Source: architecture/coding-standards.md#Error Handling Security]
- Use structured error responses with codes and messages
- Log internal errors but return generic messages to clients
- Implement proper error propagation with context preservation
- Follow security practices for error exposure

### Testing Requirements
[Source: architecture/coding-standards.md#Testing Standards]
- **Unit Tests**: Test WebSocket connection handling, message parsing, and response formatting
- **Integration Tests**: Test MCP protocol compliance with mock Claude client
- **Coverage Requirement**: 85% for business logic, 80% overall
- **Test Location**: Alongside implementation files (`*_test.go`)
- **Framework**: Go standard testing package with testify for assertions

### Logging Standards
[Source: architecture/coding-standards.md#Structured Logging]
Required structured logging format for MCP operations:
```go
logger.Info("mcp operation started",
    "operation", "websocket_connect",
    "client_id", clientID,
    "timestamp", time.Now(),
)
```

### Performance Requirements
[Source: architecture/coding-standards.md#Performance Standards]
- Connection establishment: < 1 second
- Message processing: < 100ms per message
- Concurrent connection support: 10+ connections
- Memory usage: < 128MB

## Testing
**Test file location**: Alongside implementation files (`*_test.go`)
**Test standards**: Go standard testing package with testify for assertions
**Testing frameworks**: gomock for interface mocking
**Specific requirements**:
- Unit tests for WebSocket connection lifecycle
- Integration tests for MCP protocol compliance
- Mock Claude client interactions
- Test concurrent connection handling
- Validate message parsing and response formatting

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-23 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

### Review Date: 2025-09-24

### Reviewed By: Quinn (Test Architect)

**Quality Assessment Summary:**
Story 3.1 provides excellent technical foundation and comprehensive implementation guidance. The story demonstrates strong architectural alignment and clear development context. However, several security and testability considerations should be addressed before production deployment.

**Strengths:**
- Comprehensive technical context with proper source documentation
- Clear task breakdown with acceptance criteria mapping
- Well-defined file structure following coding standards
- Thorough integration points with existing backend infrastructure
- Strong testing framework specification

**Areas for Improvement:**
- Client authentication mechanism needs explicit definition
- WebSocket security measures require specification
- Load testing scenarios needed for concurrent connections
- Tool registration interface should be considered for future extensibility

**Risk Level: Medium** - Core functionality is well-planned, but security considerations need attention

**Testability Score: 8/10** - Good test coverage planned, missing load testing scenarios

**Implementation Readiness: 9/10** - Very well prepared for development with minor security gaps

### Gate Status

Gate: CONCERNS → docs/qa/gates/3.1-mcp-server-implementation.yml
